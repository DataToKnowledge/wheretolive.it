"use strict";angular.module("wheretoliveApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","google-maps","angularCharts","angular-rickshaw","ngAutocomplete"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/news",{templateUrl:"views/news.html",controller:"NewsCtrl"}).when("/crimap",{templateUrl:"views/crimap.html",controller:"CrimapCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/analytics",{templateUrl:"views/analytics.html",controller:"AnalyticsCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/search",{templateUrl:"views/search.html",controller:"SearchCtrl"}).when("/tips",{templateUrl:"views/tips.html",controller:"TipsCtrl"}).otherwise({redirectTo:"/"})}]);var app=angular.module("wheretoliveApp");app.controller("MainCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("wheretoliveApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("wheretoliveApp").controller("NewsCtrl",["$scope","Search",function(a,b){var c="";a.paginationCurrentPage=0;var d=15,e=Math.ceil(a.results/d)-1;a.paginationGetRange=function(){var b,c=5,d=[];b=a.paginationCurrentPage,b>e-c&&(b=e-c+1);for(var f=b;b+c>f;f++)f>=0&&d.push(f);return d};var f=function(b){console.log("Entrato in setCurrentPage()",b),a.paginationCurrentPage=b};a.disablePrevPage=function(){return 0===a.paginationCurrentPage},a.disableNextPage=function(){var b=a.paginationCurrentPage===e||-1===e;return b},a.updateSearch=function(b){f(b),a.getLatestNews(),$("html,body, div.scrollit").animate({scrollTop:0},"slow")},a.map={center:{latitude:"41",longitude:"16"},options:{maxZoom:17,minZoom:2},zoom:8,clusterOptions:{maxZoom:10}},a.markersEvents={click:function(a,b,d){d.$id;var e=d.id.split("/")[0];$("#"+c).removeClass("highlightPost"),$("#"+e).addClass("highlightPost"),$("html,body, div.scrollit").animate({scrollTop:$("#"+e).offset().top-150},"slow"),c=e}},a.getCurrentPosition=function(){window.navigator.geolocation.getCurrentPosition(function(b){a.$apply(function(){a.position=b,a.map={center:a.position.coords,zoom:8}})},function(a){console.log("error get position",a)})},a.getLatestNews=function(){var c=d*a.paginationCurrentPage;console.log("GetLatestNews FROM: "+c),b.getLastNews(a.querySize,c).then(function(b){a.newsArray=b.data.hits.hits,a.results=b.data.hits.total,console.log("News",a.newsArray),g(a.newsArray)})},a.getHostname=function(a){var b=document.createElement("a");return b.href=a,b.hostname};var g=function(b){var c=new Array;c=i(b),a.markers=c},h=function(a){for(var b={},c=0;c<a.length;c++){var d=a[c].lat.toFixed(5),e=b[d];if(void 0==e){var f=a[c].lon.toFixed(5);b[d]=new Array(f)}else-1==e.indexOf(f)&&(e.push(f),b[d]=e)}return b},i=function(a){for(var b=new Array,c=0,d=.99999,e=1.00001,f={},g=0;g<a.length;g++){var i=h(a[g]._source.positions),j=Object.keys(i);console.log("***News numero "+g+" di "+a.length+"***");for(var k=0;k<j.length;k++){var l=j[k],m=f[l],n=i[l];if(void 0==m)for(var o=0;o<n.length;o++){var p={id:a[g]._id+"/"+c,latitude:l,longitude:n[o],showWindow:!0,title:a[g]._source.title};c++,b.push(p),f[l]=new Array(n[o])}else for(var o=0;o<n.length;o++){var q=n[o];if(-1==f[l].indexOf(q)){m.push(q);var p={id:a[g]._id+"/"+c,latitude:l,longitude:q,showWindow:!0,title:a[g]._source.title};c++,b.push(p),f[l]=m}else{for(var r=l*(Math.random()*(e-d)+d);-1!=Object.keys(f).indexOf(r);)r=l*(Math.random()*(e-d)+d);var s=q*(Math.random()*(e-d)+d);f[r]=new Array(s.toString());var p={id:a[g]._id+"/"+c,latitude:r,longitude:s,showWindow:!0,title:a[g]._source.title};c++,b.push(p)}}}}return b};a.init=function(){a.getCurrentPosition(),a.getLatestNews()}}]),angular.module("wheretoliveApp").controller("AnalyticsCtrl",["$scope","Search",function(a,b){a.topCrime="",a.toJournal="",a.topCrimeAggregateNumber="0",a.totalNewsCity="0",a.topCrimesPerDay=[],a.showAnalytics=function(b){a.totalCrimeCityS(b),a.histogramCrimesInCity(b),a.totalNewsInCity(b),a.topJournalsInCity(b),a.topCrime(b),a.topJournal(b),a.topCrimesPerDay(b)},a.topJournals=[],a.newspapers=[{titolo:"Giornale 1"},{titolo:"Giornale 1"},{titolo:"Giornale 1"},{titolo:"Giornale 1"},{titolo:"Giornale 1"},{titolo:"Giornale 1"},{titolo:"Giornale 1"},{titolo:"Giornale 1"},{titolo:"Giornale 1"},{titolo:"Giornale 1"}],a.topCrimes={},a.topCrimeChartType="bar",a.topCrimeConfig={tooltips:!0,labels:!1,mouseover:function(){},mouseout:function(){},click:function(){},legend:{display:!0,position:"right",htmlEnabled:!1},colors:[],innerRadius:0,lineLegend:"lineEnd",lineCurveType:"cardinal",isAnimate:!0,yAxisTickFormat:"s"},a.topCrymeDayFeatures={legend:{toggle:!0,highlight:!0},hover:{xFormatter:function(a){var b=new Date(a);return"Data "+b.toISOString().split("T")[0]},yFormatter:function(a){return"numero "+a}}},a.topDayCrimeChartType="line",a.topCrymeDayOptions={renderer:"line",stroke:!0,preserve:!0},a.topCrymeDaySeries=[{name:"Series 1",color:"steelblue",data:[{x:0,y:23},{x:1,y:15},{x:2,y:79},{x:3,y:31},{x:4,y:60}]},{name:"Series 2",color:"lightblue",data:[{x:0,y:30},{x:1,y:20},{x:2,y:64},{x:3,y:50},{x:4,y:15}]}],a.topNewspaperDaySeries=[{name:"Series 1",color:"steelblue",data:[{x:0,y:23},{x:1,y:15},{x:2,y:79},{x:3,y:31},{x:4,y:60}]},{name:"Series 2",color:"lightblue",data:[{x:0,y:30},{x:1,y:20},{x:2,y:64},{x:3,y:50},{x:4,y:15}]}],a.topNewspaperDayFeatures={},a.topDayNewspaperOptions={renderer:"area",stroke:!0,preserve:!0},a.totalCrimeCityS=function(c){b.countCrimes(c).success(function(b){var c=b.aggregations.crimes_count.buckets,d=0,e=0;for(e=0;e<c.length;e++)d+=c[e].doc_count;a.topCrimeAggregateNumber=d})},a.histogramCrimesInCity=function(c){b.histogramCrimesInCity(c).then(function(b){var c=b.data.aggregations.crimes_count.buckets,d=0,e=[],f=[];for(d=0;d<c.length;d++)e.push(c[d].key),f.push(c[d].doc_count);a.topCrimes.series=e,a.topCrimes.data=[{x:"Crimini",y:f}]})},a.totalNewsInCity=function(c){b.totalNewsInCity(c).then(function(b){var c=b.data.hits.total;a.totalNewsCity=c})},a.aggregateTopCrimesInCity=function(a){b.aggregateTopCrimesInCity(a).then(function(a){a.data.hits.total})},a.topJournalsInCity=function(c){b.topJournalsInCity(c).success(function(b){var c=b.aggregations.crimes.buckets;a.topJournals=c.slice(1,c.length)})},a.topCrime=function(c){b.topCrime(c).success(function(b){var c=b.aggregations.crime_histograms.buckets;a.topCrime=c[1].key})},a.topJournal=function(c){b.topJournal(c).success(function(b){var c=b.aggregations.top_journal.buckets;a.topJournal=c[1].key})},a.topCrimesPerDay=function(c){b.topCrimesPerDay(c).success(function(b){var c=b.aggregations.crime_top.buckets,d=[],e=0,f=c[2],g=f.key,h=f.day_histogram.buckets,i=[];for(e=h.length-1;e>=0;e--)i.push({x:h[e].key,y:h[e].doc_count});d.push({name:g,color:"lightblue",data:i}),a.topCrymeDaySeries=d})},a.init=function(){}}]),angular.module("wheretoliveApp").controller("CrimapCtrl",["$scope","Search","$http","$log",function(a,b,c){a.map={center:{latitude:"41",longitude:"16"},zoom:8},a.options={value:10},a.searchCrimes=function(){console.log(a.search)},a.getCrimesArray=function(){c({method:"GET",url:"/data/listaReati.json"}).success(function(b){a.crimesList=b.slice(0,20),console.log(JSON.stringify(b.slice(0,20)))}).error(function(){console.log("error")})},a.getCrimeMarkers=function(){},a.getCrimes=function(){c({method:"GET",url:"/data/listaReati.json"}).success(function(b){for(var c=new Array,d=b.slice(0,20),e=0;e<d.length;e++)c.push(d[e].crimine);a.crimesList=c,a.selection=c}).error(function(){console.log("error")})},a.getLastCrimeNews=function(){b.getLastCrimeNews().then(function(b){a.newsArray=b.data.hits.hits,console.log("News",a.newsArray),d(a.newsArray)})};var d=function(b){for(var c=new Array,d=0,e=0;e<b.length;e++)for(var f=0;f<b[e]._source.positions.length;f++){var g={id:b[e]._id+"/"+d,latitude:parseFloat(b[e]._source.positions[f].lat),longitude:parseFloat(b[e]._source.positions[f].lon),showWindow:!0,title:b[e]._source.title};c.push(g),d++}a.markers=c};a.toggleSelection=function(a){console.log("clisccato :"+a)},a.updateTimeOfCrime=function(b){var c=new Date(b);console.log(c.toLocaleDateString()),a.$apply()},a.init=function(){a.getCrimes(),a.getLastCrimeNews(),a.minCrimeTimeObject=new Date("01/01/2014").getTime(),a.ActualtimeDateObject=(new Date).getTime()}}]),angular.module("wheretoliveApp").controller("LoginCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("wheretoliveApp").controller("SearchCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]);var app=angular.module("wheretoliveApp");app.service("Search",["$http",function(a){this.searchFullText=function(b,c,d){var e={size:"",from:"",query:{filtered:{query:{match:{_all:{query:"",operator:"and"}}},filter:{exists:{field:"crime"}}}},sort:[{date:{order:"desc"}}]};return e.query.filtered.query.match._all.query=b,e.size=c,e.from=d,a.post("http://www.wheretolive.it/map/service/wheretolive/news/_search",e).success(function(a){return a})},this.getLastCrimeNews=function(){var b={query:{filtered:{query:{match_all:{}},filter:{exists:{field:"crime"}}}},sort:[{date:{order:"desc"}}]};return a.post("http://www.wheretolive.it/map/service/wheretolive/news/_search",b).success(function(a){return a})},this.getLastNews=function(b,c){var d={size:"",from:"",query:{match_all:{}},sort:[{date:{order:"desc"}}]};return d.size=b,d.from=c,a.post("http://www.wheretolive.it/map/service/wheretolive/news/_search",d).success(function(a){return a})},this.searchInNLPTags=function(b,c,d){var e={size:"",from:"",query:{filtered:{query:{match_all:{}},filter:{bool:{must:{nested:{path:"nlp_tags",query:{match:{"nlp_tags.name":""}}}},should:{},must_not:{missing:{field:"crime",existence:!0,null_value:!0}}}}}},sort:[{date:{order:"desc"}},{"nlp_tags.rank":{order:"desc",nested_filter:{term:{"nlp_tags.name":""}}}}]};return e.size=c,e.from=d,e.query.filtered.filter.bool.must.nested.query.match["nlp_tags.name"]=b,e.sort[1]["nlp_tags.rank"].nested_filter.term["nlp_tags.name"]=b,a.post("http://www.wheretolive.it/map/service/wheretolive/news/_search",e).success(function(a){return a})},this.searchInCities=function(b,c,d){var e={size:"",from:"",query:{filtered:{query:{match:{location:""}},filter:{exists:{field:"crime"}}}},sort:[{date:{order:"desc"}}]};return e.size=c,e.from=d,e.query.filtered.query.match.location=b,a.post("http://www.wheretolive.it/map/service/wheretolive/news/_search",e).success(function(a){return a})},this.searchInCrimes=function(b,c,d){var e={size:"",from:"",query:{filtered:{query:{match:{crime:""}},filter:{exists:{field:"crime"}}}},sort:[{date:{order:"desc"}}]};return e.from=d,e.size=c,e.query.filtered.query.match.crime=b,a.post("http://www.wheretolive.it/map/service/wheretolive/news/_search",e).success(function(a){return a})},this.countCrimes=function(b){var c={query:{filtered:{query:{bool:{must:[{match:{location:"Bari"}}]}},filter:{range:{date:{from:"now-1M/M",to:"now"}}}}},size:0,aggs:{crimes_count:{terms:{field:"crime",size:10}}}};return c.query.filtered.query.bool.must[0].match.location=b,a.post("http://www.wheretolive.it/map/service/wheretolive/news/_search",c)},this.histogramCrimesInCity=function(b){var c={query:{filtered:{query:{bool:{must:[{match:{location:""}}]}},filter:{range:{date:{from:"now-1M/M",to:"now"}}}}},size:0,aggs:{crimes_count:{terms:{field:"crime",size:10}}}};return c.query.filtered.query.bool.must[0].match.location=b,a.post("http://www.wheretolive.it/map/service/wheretolive/news/_search",c).success(function(a){return a})},this.totalNewsInCity=function(b){var c={query:{filtered:{query:{bool:{must:[{match:{location:""}}]}},filter:{range:{date:{from:"now-1M/M",to:"now"}}}}},size:0,aggs:{crimes_count:{terms:{field:"_id",size:10}}}};return c.query.filtered.query.bool.must[0].match.location=b,a.post("http://www.wheretolive.it/map/service/wheretolive/news/_search",c).success(function(a){return a})},this.topJournalsInCity=function(b){var c={query:{filtered:{query:{bool:{must:[{match:{location:"Bari"}}]}},filter:{range:{date:{from:"now-1M/M",to:"now"}}}}},size:0,aggs:{crimes:{terms:{field:"urlWebsite",size:100}}}};return c.query.filtered.query.bool.must[0].match.location=b,a.post("http://www.wheretolive.it/map/service/wheretolive/news/_search",c)},this.topCrime=function(b){var c={query:{filtered:{query:{bool:{must:[{match:{location:"Bari"}}]}},filter:{range:{date:{from:"now-1M/M",to:"now"}}}}},size:0,aggs:{crime_histograms:{terms:{field:"crime",size:50}}}};return c.query.filtered.query.bool.must[0].match.location=b,a.post("http://www.wheretolive.it/map/service/wheretolive/news/_search",c)},this.topJournal=function(b){var c={query:{filtered:{query:{bool:{must:[{match:{location:"Bari"}}]}},filter:{range:{date:{from:"now-1M/M",to:"now"}}}}},size:0,aggs:{top_journal:{terms:{field:"urlWebsite",size:50}}}};return c.query.filtered.query.bool.must[0].match.location=b,a.post("http://www.wheretolive.it/map/service/wheretolive/news/_search",c)},this.topCrimesPerDay=function(b){var c={query:{filtered:{query:{bool:{must:[{match:{location:"Bari"}}]}},filter:{range:{date:{from:"now-12M/M",to:"now"}}}}},size:0,aggs:{crime_top:{terms:{field:"crime",size:50},aggs:{day_histogram:{date_histogram:{field:"date",interval:"month",format:"MM-yyyy",order:{_key:"desc"}}}}}}};return c.query.filtered.query.bool.must[0].match.location=b,a.post("http://www.wheretolive.it/map/service/wheretolive/news/_search",c)}}]),angular.module("wheretoliveApp").controller("TipsCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("wheretoliveApp").directive("timeSlider",function(){var a,b,c;return c=function(a,b){var c,d;return c=new Date(b),d=c.toLocaleDateString(),a.innerHTML=d},b=function(a,b){var c,d;return c=new Date(b),d=c.toLocaleDateString(),a.innerHTML=d},a=function(a,b){var c,d,e;return c=new Date(b),d=c.toLocaleDateString(),e=c.toLocaleTimeString(),a.innerHTML=d},{template:"<div class='time-slider-content'><span></span><span class='startTime'></span><span></span><span class='endTime'></span><input class='time-slider-range-bar' type='range' name='crime-time-slider' /><div style='position: absolute' class='curTime'><span></span></div></div>",restrict:"E",scope:{min:"=",max:"=",callback:"="},link:function(d,e,f){var g,h,i,j,k,l,m;return j=e.find("input")[0],k=angular.element(j),m=e.find("span"),h=e.find("div")[1],l=$(j).offset(),g=!1,j.min=d.min,j.max=d.max,j.step=f.step,j.value=d.min,c(m[1],j.min),b(m[3],j.max),i=function(a){var b,c,e;return c=(a-d.min)/(d.max-d.min),e=j.clientWidth*c+l.left,b=angular.element(h),b.css("left",e-h.clientWidth/10+"px"),b.css("top",j.clientHeight-(h.clientHeight+4)+"px")},k.bind("change",function(b){var c;return g=!0,c=parseInt(b.target.value),a(m[4],c),i(c)}),k.bind("mouseup",function(a){return g=!1,d.callback.call(this,parseInt(a.target.value))}),d.$watch("min",function(a){return c(m[1],parseInt(a)),j.min=d.min,j.value=d.min,m[4].innerHTML=""}),d.$watch("max",function(a){return b(m[3],parseInt(a)),j.max=d.max})}}});