"use strict";angular.module("wheretoliveApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","uiGmapgoogle-maps","angularCharts","angular-rickshaw","ngAutocomplete","vr.directives.slider"]).config(["$logProvider",function(a){a.debugEnabled(!0)}]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/news",{templateUrl:"views/news.html",controller:"NewsCtrl"}).when("/crimap",{templateUrl:"views/crimap.html",controller:"CrimapCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/analytics",{templateUrl:"views/analytics.html",controller:"AnalyticsCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/search",{templateUrl:"views/search.html",controller:"SearchCtrl"}).when("/tips",{templateUrl:"views/tips.html",controller:"TipsCtrl"}).otherwise({redirectTo:"/"})}]);var app=angular.module("wheretoliveApp");app.controller("MainCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("wheretoliveApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("wheretoliveApp").controller("NewsCtrl",["$scope","Search",function(a,b){a.paginationCurrentPage=0;var c=10,d=Math.ceil(a.results/c)-1;a.paginationGetRange=function(){var b,c=5,e=[];b=a.paginationCurrentPage,b>d-c&&(b=d-c+1);for(var f=b;b+c>f;f++)f>=0&&e.push(f);return e};var e=function(b){a.paginationCurrentPage=b};a.disablePrevPage=function(){return 0===a.paginationCurrentPage},a.disableNextPage=function(){var b=a.paginationCurrentPage===d||-1===d;return b},a.updateSearch=function(a){e(a),h(),$("html,body, div.scrollit").animate({scrollTop:0},"slow")},a.map={center:{latitude:"41",longitude:"16"},options:{maxZoom:17,minZoom:2},zoom:8,clusterOptions:{maxZoom:10}};var f=function(){window.navigator.geolocation.getCurrentPosition(function(b){a.$apply(function(){console.log("Current position",b),a.position=b,a.map={center:a.position.coords,zoom:8},e(0),h()})},function(a){console.log("error get position",a)})},g="";a.markersEvents={click:function(a,b,c){var d=c.id.split("/")[0];d!=g&&($("#"+g).removeClass("highlightPost"),$("#"+d).addClass("highlightPost"),$("html,body, div.scrollit").animate({scrollTop:$("#"+d).offset().top-150},"slow"),g=d)}};var h=function(){var d=c*a.paginationCurrentPage;void 0==a.position?b.getLastNews(c,d).then(function(b){a.newsArray=b.data.hits.hits,a.results=b.data.hits.total,console.log("News",a.newsArray);var c=j(a.newsArray);a.markers=c}):b.getLastClosestNews(c,d,a.position).then(function(b){a.newsArray=b.data.hits.hits,a.results=b.data.hits.total,console.log("News",a.newsArray);var c=j(a.newsArray);a.markers=c})};a.getHostname=function(a){var b=document.createElement("a");return b.href=a,b.hostname};var i=function(a){for(var b={},c=0;c<a.length;c++){var d=a[c].lat.toFixed(5),e=b[d];if(void 0==e){var f=a[c].lon.toFixed(5);b[d]=new Array(f)}else-1==e.indexOf(f)&&(e.push(f),b[d]=e)}return b},j=function(a){for(var b=new Array,c=0,d=.99999,e=1.00001,f={},g=0;g<a.length;g++)for(var h=i(a[g].fields.partial1[0].positions),j=Object.keys(h),k=0;k<j.length;k++){var l=j[k],m=f[l],n=h[l];if(void 0==m)for(var o=0;o<n.length;o++){var p={id:a[g]._id+"/"+c,latitude:l,longitude:n[o],showWindow:!0,title:a[g].fields.title};c++,b.push(p),f[l]=new Array(n[o])}else for(var o=0;o<n.length;o++){var q=n[o];if(-1==f[l].indexOf(q)){m.push(q);var p={id:a[g]._id+"/"+c,latitude:l,longitude:q,showWindow:!0,title:a[g].fields.title};c++,b.push(p),f[l]=m}else{for(var r=l*(Math.random()*(e-d)+d);-1!=Object.keys(f).indexOf(r);)r=l*(Math.random()*(e-d)+d);var s=q*(Math.random()*(e-d)+d);f[r]=new Array(s.toString());var p={id:a[g]._id+"/"+c,latitude:r,longitude:s,showWindow:!0,title:a[g].fields.title};c++,b.push(p)}}}return b};a.init=function(){f(),h()}}]),angular.module("wheretoliveApp").controller("AnalyticsCtrl",["$scope","Search",function(a,b){a.topCrime="",a.toJournal="",a.topCrimeAggregateNumber="0",a.totalNewsCity="0",a.topCrimesPerDay=[],a.showAnalytics=function(b){a.totalCrimeCityS(b),a.histogramCrimesInCity(b),a.totalNewsInCity(b),a.topJournalsInCity(b),a.topCrime(b),a.topJournal(b),a.topCrimesPerDay(b)},a.topJournals=[],a.newspapers=[{titolo:"Giornale 1"},{titolo:"Giornale 1"},{titolo:"Giornale 1"},{titolo:"Giornale 1"},{titolo:"Giornale 1"},{titolo:"Giornale 1"},{titolo:"Giornale 1"},{titolo:"Giornale 1"},{titolo:"Giornale 1"},{titolo:"Giornale 1"}],a.topCrimes={},a.topCrimeChartType="bar",a.topCrimeConfig={tooltips:!0,labels:!1,mouseover:function(){},mouseout:function(){},click:function(){},legend:{display:!0,position:"right",htmlEnabled:!1},colors:[],innerRadius:0,lineLegend:"lineEnd",lineCurveType:"cardinal",isAnimate:!0,yAxisTickFormat:"s"},a.topCrymeDayFeatures={legend:{toggle:!0,highlight:!0},hover:{xFormatter:function(a){var b=new Date(a);return"Data "+b.toISOString().split("T")[0]},yFormatter:function(a){return"numero "+a}}},a.topDayCrimeChartType="line",a.topCrymeDayOptions={renderer:"line",stroke:!0,preserve:!0},a.topCrymeDaySeries=[{name:"Series 1",color:"steelblue",data:[{x:0,y:23},{x:1,y:15},{x:2,y:79},{x:3,y:31},{x:4,y:60}]},{name:"Series 2",color:"lightblue",data:[{x:0,y:30},{x:1,y:20},{x:2,y:64},{x:3,y:50},{x:4,y:15}]}],a.topNewspaperDaySeries=[{name:"Series 1",color:"steelblue",data:[{x:0,y:23},{x:1,y:15},{x:2,y:79},{x:3,y:31},{x:4,y:60}]},{name:"Series 2",color:"lightblue",data:[{x:0,y:30},{x:1,y:20},{x:2,y:64},{x:3,y:50},{x:4,y:15}]}],a.topNewspaperDayFeatures={},a.topDayNewspaperOptions={renderer:"area",stroke:!0,preserve:!0},a.totalCrimeCityS=function(c){b.countCrimes(c).success(function(b){var c=b.aggregations.crimes_count.buckets,d=0,e=0;for(e=0;e<c.length;e++)d+=c[e].doc_count;a.topCrimeAggregateNumber=d})},a.histogramCrimesInCity=function(c){b.histogramCrimesInCity(c).then(function(b){var c=b.data.aggregations.crimes_count.buckets,d=0,e=[],f=[];for(d=0;d<c.length;d++)e.push(c[d].key),f.push(c[d].doc_count);a.topCrimes.series=e,a.topCrimes.data=[{x:"Crimini",y:f}]})},a.totalNewsInCity=function(c){b.totalNewsInCity(c).then(function(b){var c=b.data.hits.total;a.totalNewsCity=c})},a.aggregateTopCrimesInCity=function(a){b.aggregateTopCrimesInCity(a).then(function(a){a.data.hits.total})},a.topJournalsInCity=function(c){b.topJournalsInCity(c).success(function(b){var c=b.aggregations.crimes.buckets;a.topJournals=c.slice(1,c.length)})},a.topCrime=function(c){b.topCrime(c).success(function(b){var c=b.aggregations.crime_histograms.buckets;a.topCrime=c[1].key})},a.topJournal=function(c){b.topJournal(c).success(function(b){var c=b.aggregations.top_journal.buckets;a.topJournal=c[1].key})},a.topCrimesPerDay=function(c){b.topCrimesPerDay(c).success(function(b){var c=b.aggregations.crime_top.buckets,d=[],e=0,f=c[2],g=f.key,h=f.day_histogram.buckets,i=[];for(e=h.length-1;e>=0;e--)i.push({x:h[e].key,y:h[e].doc_count});d.push({name:g,color:"lightblue",data:i}),a.topCrymeDaySeries=d})},a.init=function(){}}]),angular.module("wheretoliveApp").controller("CrimapCtrl",["$scope","Search","$http","$log",function(a,b,c,d){var e={zoom:8,maxZoom:14,minZoom:8,center:new google.maps.LatLng(41,16)};a.map=new google.maps.Map(document.getElementById("map"),e);var f=function(){c({method:"GET",url:"/data/listaReati.json"}).success(function(b){for(var c=new Array,d=b.slice(0,20),e=0;e<d.length;e++)c.push(d[e].crimine);a.crimesList=c}).error(function(){console.log("error")})};a.isActiveCrime=function(b){var c=a.selection.indexOf(b);return-1==c?!1:!0};var g=function(a){var b=new Date(parseInt(a));return b.toLocaleDateString("it-IT")};a.humanDate=function(a){var b=new Date(parseInt(a));return b.toLocaleDateString()},a.humanRange=function(){return d.debug("lowBound"),""},a.updateCrimeMap=function(b){var c=a.selection.indexOf(b);c>-1?a.selection.splice(c,1):a.selection.push(b)},a.applyCrimeMapFilters=function(){a.updateCrimeWindowTime()};var h=function(a){for(var b={},c=0;c<a.length;c++){var d=a[c].lat.toFixed(7),e=b[d];if(void 0==e){var f=a[c].lon.toFixed(7);b[d]=new Array(f)}else-1==e.indexOf(f)&&(e.push(f),b[d]=e)}return b},i=function(a){for(var b=(new Array,new Array),c=0,d=.9999,e=1.0001,f={},g=0;g<a.length;g++)for(var i=h(a[g]._source.positions),j=Object.keys(i),k=0;k<j.length;k++){var l=j[k],m=f[l],n=i[l];if(void 0==m)for(var o=0;o<n.length;o++){var p={location:"",weight:""};p.location=new google.maps.LatLng(l,n[o]),p.weight=1,b.push(p),c++,f[l]=new Array(n[o])}else for(var o=0;o<n.length;o++){var q=parseFloat(n[o]).toFixed(7);if(-1==f[l].indexOf(q)){m.push(q),c++;var p={location:"",weight:""};p.location=new google.maps.LatLng(l,q),p.weight=1,b.push(p),f[l]=m}else{for(var r=(parseFloat(l)*(Math.random()*(e-d)+d)).toFixed(7);-1!=Object.keys(f).indexOf(r);)r=(parseFloat(l)*(Math.random()*(e-d)+d)).toFixed(7);var s=(parseFloat(q)*(Math.random()*(e-d)+d)).toFixed(7);f[r]=new Array(s.toString()),c++;var p={location:"",weight:""};p.location=new google.maps.LatLng(r,s),p.weight=1,b.push(p)}}}return b};a.updateCrimeWindowTime=function(){var c=g(a.beginRangeTime).replace(/\//g,"-"),e=g(a.endRangeTime).replace(/\//g,"-");0!=a.selection.length&&(a.loading=!0,d.debug(a.selection),b.searchCrimeNewsForDate(a.selection,c,e).success(function(b){var c=i(b.hits.hits),d=new google.maps.MVCArray(c),e=new google.maps.visualization.HeatmapLayer({data:d,opacity:.8,maxIntensity:10,radius:10});e.setMap(a.map),a.loading=!1}).error(function(){a.loading=!1}))},a.init=function(){a.loading=!1,a.selection=new Array,a.minCrimeTime=new Date("01-01-2014"),a.minCrimeTimeObject=a.minCrimeTime.getTime(),a.curTime=a.minCrimeTimeObject,a.actualtimeDateObject=Date.now();var b=new Date(Date.now());b.setMonth(-1),a.beginRangeTime=b.getTime(),a.endRangeTime=a.actualtimeDateObject,f()}}]),angular.module("wheretoliveApp").controller("LoginCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("wheretoliveApp").controller("SearchCtrl",["$rootScope","$scope","$log",function(a,b){b.init=function(){b.searchQuery="",b.minQueryLength=3,b.queryResults=[],b.isSearchStart=!1,b.resultFound=!0},b.startSearch=function(){b.searchQuery.length>=b.minQueryLength?(b.isSearchStart=!0,b.resultFound=!1):(b.isSearchStart=!1,b.resultFound=!0)}}]);var app=angular.module("wheretoliveApp");app.service("Search",["$http",function(a){var b="http://www.wheretolive.it/map/service/wheretolive/news/_search";this.searchFullText=function(c,d,e){var f={size:"",from:"",query:{filtered:{query:{match:{_all:{query:"",operator:"and"}}},filter:{exists:{field:"crime"}}}},sort:[{date:{order:"desc"}}]};return f.query.filtered.query.match._all.query=c,f.size=d,f.from=e,a.post(b,f).success(function(a){return a})},this.searchCrimeNewsForDate=function(c,d,e){var f={size:"1000",_source:["positions"],query:{filtered:{query:{match:{crimes:{query:"",operator:"or"}}},filter:{and:{filters:[{range:{date:{gte:"01-10-2014",lte:"now"}}},{geo_distance:{distance:"200km",positions:{lat:"41.10",lon:"16.87"}}}]}}}}};return f.query.filtered.filter.and.filters[0].range.date.gte=d,f.query.filtered.filter.and.filters[0].range.date.lte=e,f.query.filtered.query.match.crimes.query=c,console.log(f),a.post(b,f).success(function(a){return a}).error(function(a){console.log(a)})},this.getLastClosestNews=function(c,d,e){console.log("getLastClosestNews with positions");var f={fields:["urlWebsite","urlNews","title","summary","date"],size:"",from:"",query:{match_all:{}},partial_fields:{partial1:{include:"positions"}},sort:[{date:{order:"desc"}},{_geo_distance:{positions:[],order:"asc",unit:"km"}}]};return f.size=c,f.from=d,f.sort[1]._geo_distance.positions[0]=e.coords.latitude,f.sort[1]._geo_distance.positions[1]=e.coords.longitude,console.log(f),a.post(b,f).success(function(a){return a})},this.getLastNews=function(c,d){console.log("getLastNews withOUT positions");var e={fields:["urlWebsite","urlNews","title","summary","date"],size:"",from:"",query:{match_all:{}},partial_fields:{partial1:{include:"positions"}},sort:[{date:{order:"desc"}}]};return e.size=c,e.from=d,a.post(b,e).success(function(a){return a})},this.searchInNLPTags=function(c,d,e){var f={size:"",from:"",query:{filtered:{query:{match_all:{}},filter:{bool:{must:{nested:{path:"nlp_tags",query:{match:{"nlp_tags.name":""}}}},should:{},must_not:{missing:{field:"crime",existence:!0,null_value:!0}}}}}},sort:[{date:{order:"desc"}},{"nlp_tags.rank":{order:"desc",nested_filter:{term:{"nlp_tags.name":""}}}}]};return f.size=d,f.from=e,f.query.filtered.filter.bool.must.nested.query.match["nlp_tags.name"]=c,f.sort[1]["nlp_tags.rank"].nested_filter.term["nlp_tags.name"]=c,a.post(b,f).success(function(a){return a})},this.searchInCities=function(c,d,e){var f={size:"",from:"",query:{filtered:{query:{match:{location:""}},filter:{exists:{field:"crime"}}}},sort:[{date:{order:"desc"}}]};return f.size=d,f.from=e,f.query.filtered.query.match.location=c,a.post(b,f).success(function(a){return a})},this.searchInCrimes=function(c,d,e){var f={size:"",from:"",query:{filtered:{query:{match:{crime:""}},filter:{exists:{field:"crime"}}}},sort:[{date:{order:"desc"}}]};return f.from=e,f.size=d,f.query.filtered.query.match.crime=c,a.post(b,f).success(function(a){return a})},this.countCrimes=function(c){var d={query:{filtered:{query:{bool:{must:[{match:{location:"Bari"}}]}},filter:{range:{date:{from:"now-1M/M",to:"now"}}}}},size:0,aggs:{crimes_count:{terms:{field:"crime",size:10}}}};return d.query.filtered.query.bool.must[0].match.location=c,a.post(b,d)},this.histogramCrimesInCity=function(c){var d={query:{filtered:{query:{bool:{must:[{match:{location:""}}]}},filter:{range:{date:{from:"now-1M/M",to:"now"}}}}},size:0,aggs:{crimes_count:{terms:{field:"crime",size:10}}}};return d.query.filtered.query.bool.must[0].match.location=c,a.post(b,d).success(function(a){return a})},this.totalNewsInCity=function(c){var d={query:{filtered:{query:{bool:{must:[{match:{location:""}}]}},filter:{range:{date:{from:"now-1M/M",to:"now"}}}}},size:0,aggs:{crimes_count:{terms:{field:"_id",size:10}}}};return d.query.filtered.query.bool.must[0].match.location=c,a.post(b,d).success(function(a){return a})},this.topJournalsInCity=function(c){var d={query:{filtered:{query:{bool:{must:[{match:{location:"Bari"}}]}},filter:{range:{date:{from:"now-1M/M",to:"now"}}}}},size:0,aggs:{crimes:{terms:{field:"urlWebsite",size:100}}}};return d.query.filtered.query.bool.must[0].match.location=c,a.post(b,d)},this.topCrime=function(c){var d={query:{filtered:{query:{bool:{must:[{match:{location:"Bari"}}]}},filter:{range:{date:{from:"now-1M/M",to:"now"}}}}},size:0,aggs:{crime_histograms:{terms:{field:"crime",size:50}}}};return d.query.filtered.query.bool.must[0].match.location=c,a.post(b,d)},this.topJournal=function(c){var d={query:{filtered:{query:{bool:{must:[{match:{location:"Bari"}}]}},filter:{range:{date:{from:"now-1M/M",to:"now"}}}}},size:0,aggs:{top_journal:{terms:{field:"urlWebsite",size:50}}}};return d.query.filtered.query.bool.must[0].match.location=c,a.post(b,d)},this.topCrimesPerDay=function(c){var d={query:{filtered:{query:{bool:{must:[{match:{location:"Bari"}}]}},filter:{range:{date:{from:"now-12M/M",to:"now"}}}}},size:0,aggs:{crime_top:{terms:{field:"crime",size:50},aggs:{day_histogram:{date_histogram:{field:"date",interval:"month",format:"MM-yyyy",order:{_key:"desc"}}}}}}};return d.query.filtered.query.bool.must[0].match.location=c,a.post(b,d)},this.crimePerTimeWindow=function(b,c){var d=b.getMonth()+1+"-"+b.getDate()+"-"+b.getFullYear(),e=c.getMonth()+1+"-"+c.getDate()+"-"+c.getFullYear(),f={query:{filtered:{query:{bool:{must:[{match:{location:"Bari"}}]}},filter:{range:{date:{from:d,to:e}}}}},size:0};return a.post("http://www.wheretolive.it/map/service/wheretolive/news/_search",f)}}]),angular.module("wheretoliveApp").controller("TipsCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]);